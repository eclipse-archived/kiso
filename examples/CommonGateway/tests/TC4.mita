/**
 * Welcome to Eclipse Mita.
 *
 * Not sure what to do now?
 * Check out the "Getting started" guide on https://mita.io.
 */

package main;
import platforms.cgw;

/** Struct and variables definitions **/
/* Declare variables for the BME280 */
var mean_p = 0;
var mean_h = 0;
var mean_t = 0;

/** Setup **/
/* Setup logging */
setup CGW {
       consoleInterface = .RTT();
}

/* Setup the accelerometer sensor BMA280 */
setup accelerometer {
}

/* Setup the environment sensor BME280 */
setup environment {
}

/* Setup cellular */
setup net: Radio {
       radioStandard = .CAT_M1();  
}

/* Setup http rest client */
setup backend: HttpRestClient {
       transport = net;    
       endpointBase = "http://demo.thingsboard.io";
       var x = resource(endpoint = "/api/v1/hAQ3Z4vnfcu3I3QjUb0R/telemetry");
}

/** Logic **/
every 1 second {
	/* Read sensor values */
	
	mean_p = environment.pressure.read();
	mean_h = environment.humidity.read();
	mean_t = environment.temperature.read();
	
	/* Serialize message to send out */
	let msg = `{
		"p": ${mean_p},
		"h": ${mean_h},
		"t": ${mean_t}
		}`;
	backend.x.write(msg);
}